version: 2
jobs:
  build:
    machine:
      java:
        version: openjdk7
    steps:
      - checkout
      - run: ant test
      - run: jar -cvf sample.war META-INF/ WEB-INF/ hello.jsp images/ index.html
  
  deploy:
    machine:
      java:
        version: openjdk7
    steps:
      - checkout
      - run: ant test
      - run: jar -cvf /home/circleci/project/sample.war META-INF/ WEB-INF/ hello.jsp images/ index.html
      - run: aws s3 sync /home/circleci/project/sample.war s3://build-artifacts-java-aig-test/java-apps/ --delete
  build-docker:
    machine:
      java:
        version: openjdk7
    steps:
      - checkout
      - run: ant test
      - run: jar -cvf /home/circleci/project/sample.war META-INF/ WEB-INF/ hello.jsp images/ index.html
      - run: aws s3 sync /home/circleci/project/sample.war s3://build-artifacts-java-aig-test/java-apps/ --delete
      - run: docker build -t was-sample-app .
  run-docker:
    docker:
      - image: was-sample-app
    steps:
      - checkout
      - run: docker run -d -p 80:9080 -p 443:9443 was-sample-app   

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
      - build-docker
      - run-docker:
          requires:
            - build-docker     
